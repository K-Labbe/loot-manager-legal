<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Open Loot Manager</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 20px; line-height: 1.4; }
    .btn { display:inline-block; padding:12px 16px; margin:6px 0; border-radius:10px; background:#111; color:#fff; text-decoration:none; }
    .btn.secondary { background:#555; }
    .muted { color:#666; font-size:12px; }
    pre { background:#f5f5f5; padding:10px; border-radius:8px; overflow:auto; }
    @media (prefers-color-scheme: dark) {
      body { background:#111; color:#eee; }
      .btn { background:#eee; color:#111; }
      .btn.secondary { background:#aaa; color:#111; }
      pre { background:#1b1b1b; }
      .muted { color:#aaa; }
    }
  </style>
</head>
<body>
  <h1>Open Loot Manager</h1>
  <p>If the app doesn’t open automatically, use one of these:</p>
  <p><a id="openIntent" class="btn" href="#">Open in app (Intent)</a></p>
  <p><a id="openScheme" class="btn secondary" href="#">Open in app (Scheme)</a></p>
  <p class="muted">If you’re in Gmail’s viewer, tap the ⋮ menu → <b>Open in browser</b>, then tap a button above.</p>

  <details>
    <summary>Diagnostics</summary>
    <p>Bridge URL:</p>
    <pre id="selfUrl"></pre>
    <p>Computed deep links:</p>
    <pre id="dlOut"></pre>
  </details>

  <script>
    (function () {
      // Gather params from ?query and #hash (Supabase puts tokens in the hash)
      const here = new URL(window.location.href);
      const out = new URLSearchParams(here.search);
      const hash = here.hash && here.hash.startsWith('#') ? here.hash.slice(1) : here.hash;
      if (hash) {
        const hs = new URLSearchParams(hash);
        for (const [k, v] of hs.entries()) if (!out.has(k)) out.set(k, v);
      }

      const type = (out.get('type') || '').toLowerCase();
      const at = out.get('access_token') || out.get('accessToken') || '';
      const rt = out.get('refresh_token') || out.get('refreshToken') || '';

      const qs = new URLSearchParams();
      if (type) qs.set('type', type);
      if (at) qs.set('access_token', at);
      if (rt) qs.set('refresh_token', rt);

      const scheme = 'lootmanager://auth-callback' + (qs.toString() ? ('?' + qs.toString()) : '');
      const intent = 'intent://auth-callback' + (qs.toString() ? ('?' + qs.toString()) : '') +
                     '#Intent;scheme=lootmanager;package=com.klabbe.lootmanager;end';

      document.getElementById('selfUrl').textContent = window.location.href;
      document.getElementById('dlOut').textContent = scheme + '\n' + intent;

      const openIntent = document.getElementById('openIntent');
      const openScheme = document.getElementById('openScheme');
      openIntent.setAttribute('href', intent);
      openScheme.setAttribute('href', scheme);

      // Auto: try scheme then intent (harmless if blocked)
      try { window.location.replace(scheme); } catch {}
      setTimeout(() => { try { window.location.replace(intent); } catch {} }, 900);
    })();
  </script>
</body>
</html>
